apiVersion: batch/v1
kind: CronJob
metadata:
  annotations:
    product-id: openshift-worker-vcpu-cloudscale-besteffort
  labels:
    app.kubernetes.io/managed-by: commodore
    app.kubernetes.io/name: appuio-cloud-reporting
    app.kubernetes.io/part-of: syn
    name: backfill-openshift-worker-vcpu-cloudscale-besteffort
  name: backfill-openshift-worker-vcpu-cloudscale-besteffort
  namespace: appuio-cloud-reporting
spec:
  failedJobsHistoryLimit: 768
  jobTemplate:
    metadata:
      annotations:
        product-id: openshift-worker-vcpu-cloudscale-besteffort
      labels:
        app.kubernetes.io/managed-by: commodore
        app.kubernetes.io/name: appuio-cloud-reporting
        app.kubernetes.io/part-of: syn
        cron-job-name: backfill-openshift-worker-vcpu-cloudscale-besteffort
    spec:
      template:
        metadata:
          labels:
            app.kubernetes.io/managed-by: commodore
            app.kubernetes.io/name: appuio-cloud-reporting
            app.kubernetes.io/part-of: syn
        spec:
          containers:
            - args:
                - appuio-cloud-reporting report --begin=$(date -d "now -3 hours" -u
                  +"%Y-%m-%dT%H:00:00Z") --repeat-until=$(date -u -Iseconds)
              command:
                - sh
                - -c
              env:
                - name: ACR_ODOO_OAUTH_TOKEN_URL
                  valueFrom:
                    secretKeyRef:
                      key: token_url
                      name: odoo-credentials
                - name: ACR_ODOO_OAUTH_CLIENT_ID
                  valueFrom:
                    secretKeyRef:
                      key: client_id
                      name: odoo-credentials
                - name: ACR_ODOO_OAUTH_CLIENT_SECRET
                  valueFrom:
                    secretKeyRef:
                      key: client_secret
                      name: odoo-credentials
                - name: ACR_ODOO_URL
                - name: ACR_PROM_URL
                  valueFrom:
                    secretKeyRef:
                      key: url
                      name: prom-url
                - name: ACR_PRODUCT_ID
                  value: openshift-worker-vcpu-cloudscale-besteffort
                - name: ACR_QUERY
                  value: |
                    # Calculates vCPUs for app nodes of a cluster
                    # Max values over one hour.
                    max_over_time(
                      sum by(cluster_id, vshn_service_level, tenant_id, role, cloud_provider, sales_order_id) (
                        node_cpu_info * on (tenant_id, cluster_id, instance) group_left(role)
                          label_join(
                            kube_node_role{role=~"app|storage"},
                            "instance",
                            "",
                            "node"
                          ) * on(cluster_id) group_left(tenant_id, vshn_service_level, cloud_provider, sales_order_id)
                            max by(cluster_id, tenant_id, vshn_service_level, cloud_provider, sales_order_id)
                              (appuio_managed_info{cloud_provider="cloudscale", vshn_service_level="best-effort"})
                      )[59m:1m]
                    )
                - name: ACR_INSTANCE_PATTERN
                  value: '%(cluster_id)s'
                - name: ACR_ITEM_GROUP_DESCRIPTION_PATTERN
                  value: 'APPUiO Managed OpenShift - Cluster: %(cluster_id)s'
                - name: ACR_ITEM_DESCRIPTION_PATTERN
                  value: All Compute Resources
                - name: ACR_UNIT_ID
                  value: '300'
              image: ghcr.io/appuio/appuio-cloud-reporting:v0.17.0
              name: backfill
              resources: {}
          initContainers: []
          restartPolicy: OnFailure
  schedule: 15 * * * *
  startingDeadlineSeconds: 180
  successfulJobsHistoryLimit: 3
  suspend: false
---
apiVersion: batch/v1
kind: CronJob
metadata:
  annotations:
    product-id: openshift-worker-vcpu-cloudscale-guaranteedavailability
  labels:
    app.kubernetes.io/managed-by: commodore
    app.kubernetes.io/name: appuio-cloud-reporting
    app.kubernetes.io/part-of: syn
    name: backfill-openshift-worker-vcpu-cloudscale-guaranteedavailability
  name: backfill-openshift-worker-vcpu-cloudscale-guaranteedavailability
  namespace: appuio-cloud-reporting
spec:
  failedJobsHistoryLimit: 768
  jobTemplate:
    metadata:
      annotations:
        product-id: openshift-worker-vcpu-cloudscale-guaranteedavailability
      labels:
        app.kubernetes.io/managed-by: commodore
        app.kubernetes.io/name: appuio-cloud-reporting
        app.kubernetes.io/part-of: syn
        cron-job-name: backfill-openshift-worker-vcpu-cloudscale-guaranteedavailability
    spec:
      template:
        metadata:
          labels:
            app.kubernetes.io/managed-by: commodore
            app.kubernetes.io/name: appuio-cloud-reporting
            app.kubernetes.io/part-of: syn
        spec:
          containers:
            - args:
                - appuio-cloud-reporting report --begin=$(date -d "now -3 hours" -u
                  +"%Y-%m-%dT%H:00:00Z") --repeat-until=$(date -u -Iseconds)
              command:
                - sh
                - -c
              env:
                - name: ACR_ODOO_OAUTH_TOKEN_URL
                  valueFrom:
                    secretKeyRef:
                      key: token_url
                      name: odoo-credentials
                - name: ACR_ODOO_OAUTH_CLIENT_ID
                  valueFrom:
                    secretKeyRef:
                      key: client_id
                      name: odoo-credentials
                - name: ACR_ODOO_OAUTH_CLIENT_SECRET
                  valueFrom:
                    secretKeyRef:
                      key: client_secret
                      name: odoo-credentials
                - name: ACR_ODOO_URL
                - name: ACR_PROM_URL
                  valueFrom:
                    secretKeyRef:
                      key: url
                      name: prom-url
                - name: ACR_PRODUCT_ID
                  value: openshift-worker-vcpu-cloudscale-guaranteedavailability
                - name: ACR_QUERY
                  value: |
                    # Calculates vCPUs for app nodes of a cluster
                    # Max values over one hour.
                    max_over_time(
                      sum by(cluster_id, vshn_service_level, tenant_id, role, cloud_provider, sales_order_id) (
                        node_cpu_info * on (tenant_id, cluster_id, instance) group_left(role)
                          label_join(
                            kube_node_role{role=~"app|storage"},
                            "instance",
                            "",
                            "node"
                          ) * on(cluster_id) group_left(tenant_id, vshn_service_level, cloud_provider, sales_order_id)
                            max by(cluster_id, tenant_id, vshn_service_level, cloud_provider, sales_order_id)
                              (appuio_managed_info{cloud_provider="cloudscale", vshn_service_level="guaranteed-availability"})
                      )[59m:1m]
                    )
                - name: ACR_INSTANCE_PATTERN
                  value: '%(cluster_id)s'
                - name: ACR_ITEM_GROUP_DESCRIPTION_PATTERN
                  value: 'APPUiO Managed OpenShift - Cluster: %(cluster_id)s'
                - name: ACR_ITEM_DESCRIPTION_PATTERN
                  value: All Compute Resources
                - name: ACR_UNIT_ID
                  value: '300'
              image: ghcr.io/appuio/appuio-cloud-reporting:v0.17.0
              name: backfill
              resources: {}
          initContainers: []
          restartPolicy: OnFailure
  schedule: 15 * * * *
  startingDeadlineSeconds: 180
  successfulJobsHistoryLimit: 3
  suspend: false
---
apiVersion: batch/v1
kind: CronJob
metadata:
  annotations:
    product-id: openshift-worker-vcpu-exoscale-besteffort
  labels:
    app.kubernetes.io/managed-by: commodore
    app.kubernetes.io/name: appuio-cloud-reporting
    app.kubernetes.io/part-of: syn
    name: backfill-openshift-worker-vcpu-exoscale-besteffort
  name: backfill-openshift-worker-vcpu-exoscale-besteffort
  namespace: appuio-cloud-reporting
spec:
  failedJobsHistoryLimit: 768
  jobTemplate:
    metadata:
      annotations:
        product-id: openshift-worker-vcpu-exoscale-besteffort
      labels:
        app.kubernetes.io/managed-by: commodore
        app.kubernetes.io/name: appuio-cloud-reporting
        app.kubernetes.io/part-of: syn
        cron-job-name: backfill-openshift-worker-vcpu-exoscale-besteffort
    spec:
      template:
        metadata:
          labels:
            app.kubernetes.io/managed-by: commodore
            app.kubernetes.io/name: appuio-cloud-reporting
            app.kubernetes.io/part-of: syn
        spec:
          containers:
            - args:
                - appuio-cloud-reporting report --begin=$(date -d "now -3 hours" -u
                  +"%Y-%m-%dT%H:00:00Z") --repeat-until=$(date -u -Iseconds)
              command:
                - sh
                - -c
              env:
                - name: ACR_ODOO_OAUTH_TOKEN_URL
                  valueFrom:
                    secretKeyRef:
                      key: token_url
                      name: odoo-credentials
                - name: ACR_ODOO_OAUTH_CLIENT_ID
                  valueFrom:
                    secretKeyRef:
                      key: client_id
                      name: odoo-credentials
                - name: ACR_ODOO_OAUTH_CLIENT_SECRET
                  valueFrom:
                    secretKeyRef:
                      key: client_secret
                      name: odoo-credentials
                - name: ACR_ODOO_URL
                - name: ACR_PROM_URL
                  valueFrom:
                    secretKeyRef:
                      key: url
                      name: prom-url
                - name: ACR_PRODUCT_ID
                  value: openshift-worker-vcpu-exoscale-besteffort
                - name: ACR_QUERY
                  value: |
                    # Calculates vCPUs for app nodes of a cluster
                    # Max values over one hour.
                    max_over_time(
                      sum by(cluster_id, vshn_service_level, tenant_id, role, cloud_provider, sales_order_id) (
                        node_cpu_info * on (tenant_id, cluster_id, instance) group_left(role)
                          label_join(
                            kube_node_role{role=~"app|storage"},
                            "instance",
                            "",
                            "node"
                          ) * on(cluster_id) group_left(tenant_id, vshn_service_level, cloud_provider, sales_order_id)
                            max by(cluster_id, tenant_id, vshn_service_level, cloud_provider, sales_order_id)
                              (appuio_managed_info{cloud_provider="exoscale", vshn_service_level="best-effort"})
                      )[59m:1m]
                    )
                - name: ACR_INSTANCE_PATTERN
                  value: '%(cluster_id)s'
                - name: ACR_ITEM_GROUP_DESCRIPTION_PATTERN
                  value: 'APPUiO Managed OpenShift - Cluster: %(cluster_id)s'
                - name: ACR_ITEM_DESCRIPTION_PATTERN
                  value: All Compute Resources
                - name: ACR_UNIT_ID
                  value: '300'
              image: ghcr.io/appuio/appuio-cloud-reporting:v0.17.0
              name: backfill
              resources: {}
          initContainers: []
          restartPolicy: OnFailure
  schedule: 15 * * * *
  startingDeadlineSeconds: 180
  successfulJobsHistoryLimit: 3
  suspend: false
---
apiVersion: batch/v1
kind: CronJob
metadata:
  annotations:
    product-id: openshift-worker-vcpu-exoscale-guaranteedavailability
  labels:
    app.kubernetes.io/managed-by: commodore
    app.kubernetes.io/name: appuio-cloud-reporting
    app.kubernetes.io/part-of: syn
    name: backfill-openshift-worker-vcpu-exoscale-guaranteedavailability
  name: backfill-openshift-worker-vcpu-exoscale-guaranteedavailability
  namespace: appuio-cloud-reporting
spec:
  failedJobsHistoryLimit: 768
  jobTemplate:
    metadata:
      annotations:
        product-id: openshift-worker-vcpu-exoscale-guaranteedavailability
      labels:
        app.kubernetes.io/managed-by: commodore
        app.kubernetes.io/name: appuio-cloud-reporting
        app.kubernetes.io/part-of: syn
        cron-job-name: backfill-openshift-worker-vcpu-exoscale-guaranteedavailability
    spec:
      template:
        metadata:
          labels:
            app.kubernetes.io/managed-by: commodore
            app.kubernetes.io/name: appuio-cloud-reporting
            app.kubernetes.io/part-of: syn
        spec:
          containers:
            - args:
                - appuio-cloud-reporting report --begin=$(date -d "now -3 hours" -u
                  +"%Y-%m-%dT%H:00:00Z") --repeat-until=$(date -u -Iseconds)
              command:
                - sh
                - -c
              env:
                - name: ACR_ODOO_OAUTH_TOKEN_URL
                  valueFrom:
                    secretKeyRef:
                      key: token_url
                      name: odoo-credentials
                - name: ACR_ODOO_OAUTH_CLIENT_ID
                  valueFrom:
                    secretKeyRef:
                      key: client_id
                      name: odoo-credentials
                - name: ACR_ODOO_OAUTH_CLIENT_SECRET
                  valueFrom:
                    secretKeyRef:
                      key: client_secret
                      name: odoo-credentials
                - name: ACR_ODOO_URL
                - name: ACR_PROM_URL
                  valueFrom:
                    secretKeyRef:
                      key: url
                      name: prom-url
                - name: ACR_PRODUCT_ID
                  value: openshift-worker-vcpu-exoscale-guaranteedavailability
                - name: ACR_QUERY
                  value: |
                    # Calculates vCPUs for app nodes of a cluster
                    # Max values over one hour.
                    max_over_time(
                      sum by(cluster_id, vshn_service_level, tenant_id, role, cloud_provider, sales_order_id) (
                        node_cpu_info * on (tenant_id, cluster_id, instance) group_left(role)
                          label_join(
                            kube_node_role{role=~"app|storage"},
                            "instance",
                            "",
                            "node"
                          ) * on(cluster_id) group_left(tenant_id, vshn_service_level, cloud_provider, sales_order_id)
                            max by(cluster_id, tenant_id, vshn_service_level, cloud_provider, sales_order_id)
                              (appuio_managed_info{cloud_provider="exoscale", vshn_service_level="guaranteed-availability"})
                      )[59m:1m]
                    )
                - name: ACR_INSTANCE_PATTERN
                  value: '%(cluster_id)s'
                - name: ACR_ITEM_GROUP_DESCRIPTION_PATTERN
                  value: 'APPUiO Managed OpenShift - Cluster: %(cluster_id)s'
                - name: ACR_ITEM_DESCRIPTION_PATTERN
                  value: All Compute Resources
                - name: ACR_UNIT_ID
                  value: '300'
              image: ghcr.io/appuio/appuio-cloud-reporting:v0.17.0
              name: backfill
              resources: {}
          initContainers: []
          restartPolicy: OnFailure
  schedule: 15 * * * *
  startingDeadlineSeconds: 180
  successfulJobsHistoryLimit: 3
  suspend: false
---
apiVersion: batch/v1
kind: CronJob
metadata:
  annotations:
    product-id: bopenshift-worker-vcpu-cloudscale-besteffort
  labels:
    app.kubernetes.io/managed-by: commodore
    app.kubernetes.io/name: appuio-cloud-reporting
    app.kubernetes.io/part-of: syn
    name: backfill-bopenshift-worker-vcpu-cloudscale-besteffort
  name: backfill-bopenshift-worker-vcpu-cloudscale-besteffort
  namespace: appuio-cloud-reporting
spec:
  failedJobsHistoryLimit: 768
  jobTemplate:
    metadata:
      annotations:
        product-id: bopenshift-worker-vcpu-cloudscale-besteffort
      labels:
        app.kubernetes.io/managed-by: commodore
        app.kubernetes.io/name: appuio-cloud-reporting
        app.kubernetes.io/part-of: syn
        cron-job-name: backfill-bopenshift-worker-vcpu-cloudscale-besteffort
    spec:
      template:
        metadata:
          labels:
            app.kubernetes.io/managed-by: commodore
            app.kubernetes.io/name: appuio-cloud-reporting
            app.kubernetes.io/part-of: syn
        spec:
          containers:
            - args:
                - appuio-cloud-reporting report --begin=$(date -d "now -3 hours" -u
                  +"%Y-%m-%dT%H:00:00Z") --repeat-until=$(date -u -Iseconds)
              command:
                - sh
                - -c
              env:
                - name: ACR_ODOO_OAUTH_TOKEN_URL
                  valueFrom:
                    secretKeyRef:
                      key: token_url
                      name: odoo-credentials
                - name: ACR_ODOO_OAUTH_CLIENT_ID
                  valueFrom:
                    secretKeyRef:
                      key: client_id
                      name: odoo-credentials
                - name: ACR_ODOO_OAUTH_CLIENT_SECRET
                  valueFrom:
                    secretKeyRef:
                      key: client_secret
                      name: odoo-credentials
                - name: ACR_ODOO_URL
                - name: ACR_PROM_URL
                  valueFrom:
                    secretKeyRef:
                      key: url
                      name: prom-url
                - name: ACR_PRODUCT_ID
                  value: bopenshift-worker-vcpu-cloudscale-besteffort
                - name: ACR_QUERY
                  value: |-
                    # Calculates vCPUs for app nodes of a cluster
                    # Max values over one hour.
                    max_over_time(
                      sum by(cluster_id, vshn_service_level, tenant_id, role, cloud_provider, sales_order_id) (
                        node_cpu_info * on (tenant_id, cluster_id, instance) group_left(role)
                          label_join(
                            kube_node_role{role=~"app|storage"},
                            "instance",
                            "",
                            "node"
                          ) * on(cluster_id) group_left(tenant_id, vshn_service_level, cloud_provider, sales_order_id)
                            max by(cluster_id, tenant_id, vshn_service_level, cloud_provider, sales_order_id)
                              (appuio_managed_info{cloud_provider="cloudscale", vshn_service_level="best-effort"})
                      )[59m:1m]
                    )
                - name: ACR_INSTANCE_PATTERN
                  value: '%(cluster_id)s'
                - name: ACR_ITEM_GROUP_DESCRIPTION_PATTERN
                  value: 'APPUiO Managed BOpenShift - Cluster: %(cluster_id)s'
                - name: ACR_ITEM_DESCRIPTION_PATTERN
                  value: All Compute Resources
                - name: ACR_UNIT_ID
                  value: '300'
              image: ghcr.io/appuio/appuio-cloud-reporting:v0.17.0
              name: backfill
              resources: {}
          initContainers: []
          restartPolicy: OnFailure
  schedule: 15 * * * *
  startingDeadlineSeconds: 180
  successfulJobsHistoryLimit: 3
  suspend: false
---
apiVersion: batch/v1
kind: CronJob
metadata:
  annotations:
    product-id: bopenshift-worker-vcpu-cloudscale-guaranteedavailability
  labels:
    app.kubernetes.io/managed-by: commodore
    app.kubernetes.io/name: appuio-cloud-reporting
    app.kubernetes.io/part-of: syn
    name: backfill-bopenshift-worker-vcpu-cloudscale-guaranteedavailability
  name: backfill-bopenshift-worker-vcpu-cloudscale-guaranteedavailability
  namespace: appuio-cloud-reporting
spec:
  failedJobsHistoryLimit: 768
  jobTemplate:
    metadata:
      annotations:
        product-id: bopenshift-worker-vcpu-cloudscale-guaranteedavailability
      labels:
        app.kubernetes.io/managed-by: commodore
        app.kubernetes.io/name: appuio-cloud-reporting
        app.kubernetes.io/part-of: syn
        cron-job-name: backfill-bopenshift-worker-vcpu-cloudscale-guaranteedavailability
    spec:
      template:
        metadata:
          labels:
            app.kubernetes.io/managed-by: commodore
            app.kubernetes.io/name: appuio-cloud-reporting
            app.kubernetes.io/part-of: syn
        spec:
          containers:
            - args:
                - appuio-cloud-reporting report --begin=$(date -d "now -3 hours" -u
                  +"%Y-%m-%dT%H:00:00Z") --repeat-until=$(date -u -Iseconds)
              command:
                - sh
                - -c
              env:
                - name: ACR_ODOO_OAUTH_TOKEN_URL
                  valueFrom:
                    secretKeyRef:
                      key: token_url
                      name: odoo-credentials
                - name: ACR_ODOO_OAUTH_CLIENT_ID
                  valueFrom:
                    secretKeyRef:
                      key: client_id
                      name: odoo-credentials
                - name: ACR_ODOO_OAUTH_CLIENT_SECRET
                  valueFrom:
                    secretKeyRef:
                      key: client_secret
                      name: odoo-credentials
                - name: ACR_ODOO_URL
                - name: ACR_PROM_URL
                  valueFrom:
                    secretKeyRef:
                      key: url
                      name: prom-url
                - name: ACR_PRODUCT_ID
                  value: bopenshift-worker-vcpu-cloudscale-guaranteedavailability
                - name: ACR_QUERY
                  value: |-
                    # Calculates vCPUs for app nodes of a cluster
                    # Max values over one hour.
                    max_over_time(
                      sum by(cluster_id, vshn_service_level, tenant_id, role, cloud_provider, sales_order_id) (
                        node_cpu_info * on (tenant_id, cluster_id, instance) group_left(role)
                          label_join(
                            kube_node_role{role=~"app|storage"},
                            "instance",
                            "",
                            "node"
                          ) * on(cluster_id) group_left(tenant_id, vshn_service_level, cloud_provider, sales_order_id)
                            max by(cluster_id, tenant_id, vshn_service_level, cloud_provider, sales_order_id)
                              (appuio_managed_info{cloud_provider="cloudscale", vshn_service_level="guaranteed-availability"})
                      )[59m:1m]
                    )
                - name: ACR_INSTANCE_PATTERN
                  value: '%(cluster_id)s'
                - name: ACR_ITEM_GROUP_DESCRIPTION_PATTERN
                  value: 'APPUiO Managed BOpenShift - Cluster: %(cluster_id)s'
                - name: ACR_ITEM_DESCRIPTION_PATTERN
                  value: All Compute Resources
                - name: ACR_UNIT_ID
                  value: '300'
              image: ghcr.io/appuio/appuio-cloud-reporting:v0.17.0
              name: backfill
              resources: {}
          initContainers: []
          restartPolicy: OnFailure
  schedule: 15 * * * *
  startingDeadlineSeconds: 180
  successfulJobsHistoryLimit: 3
  suspend: false
---
apiVersion: batch/v1
kind: CronJob
metadata:
  annotations:
    product-id: bopenshift-worker-vcpu-exoscale-besteffort
  labels:
    app.kubernetes.io/managed-by: commodore
    app.kubernetes.io/name: appuio-cloud-reporting
    app.kubernetes.io/part-of: syn
    name: backfill-bopenshift-worker-vcpu-exoscale-besteffort
  name: backfill-bopenshift-worker-vcpu-exoscale-besteffort
  namespace: appuio-cloud-reporting
spec:
  failedJobsHistoryLimit: 768
  jobTemplate:
    metadata:
      annotations:
        product-id: bopenshift-worker-vcpu-exoscale-besteffort
      labels:
        app.kubernetes.io/managed-by: commodore
        app.kubernetes.io/name: appuio-cloud-reporting
        app.kubernetes.io/part-of: syn
        cron-job-name: backfill-bopenshift-worker-vcpu-exoscale-besteffort
    spec:
      template:
        metadata:
          labels:
            app.kubernetes.io/managed-by: commodore
            app.kubernetes.io/name: appuio-cloud-reporting
            app.kubernetes.io/part-of: syn
        spec:
          containers:
            - args:
                - appuio-cloud-reporting report --begin=$(date -d "now -3 hours" -u
                  +"%Y-%m-%dT%H:00:00Z") --repeat-until=$(date -u -Iseconds)
              command:
                - sh
                - -c
              env:
                - name: ACR_ODOO_OAUTH_TOKEN_URL
                  valueFrom:
                    secretKeyRef:
                      key: token_url
                      name: odoo-credentials
                - name: ACR_ODOO_OAUTH_CLIENT_ID
                  valueFrom:
                    secretKeyRef:
                      key: client_id
                      name: odoo-credentials
                - name: ACR_ODOO_OAUTH_CLIENT_SECRET
                  valueFrom:
                    secretKeyRef:
                      key: client_secret
                      name: odoo-credentials
                - name: ACR_ODOO_URL
                - name: ACR_PROM_URL
                  valueFrom:
                    secretKeyRef:
                      key: url
                      name: prom-url
                - name: ACR_PRODUCT_ID
                  value: bopenshift-worker-vcpu-exoscale-besteffort
                - name: ACR_QUERY
                  value: |-
                    # Calculates vCPUs for app nodes of a cluster
                    # Max values over one hour.
                    max_over_time(
                      sum by(cluster_id, vshn_service_level, tenant_id, role, cloud_provider, sales_order_id) (
                        node_cpu_info * on (tenant_id, cluster_id, instance) group_left(role)
                          label_join(
                            kube_node_role{role=~"app|storage"},
                            "instance",
                            "",
                            "node"
                          ) * on(cluster_id) group_left(tenant_id, vshn_service_level, cloud_provider, sales_order_id)
                            max by(cluster_id, tenant_id, vshn_service_level, cloud_provider, sales_order_id)
                              (appuio_managed_info{cloud_provider="exoscale", vshn_service_level="best-effort"})
                      )[59m:1m]
                    )
                - name: ACR_INSTANCE_PATTERN
                  value: '%(cluster_id)s'
                - name: ACR_ITEM_GROUP_DESCRIPTION_PATTERN
                  value: 'APPUiO Managed BOpenShift - Cluster: %(cluster_id)s'
                - name: ACR_ITEM_DESCRIPTION_PATTERN
                  value: All Compute Resources
                - name: ACR_UNIT_ID
                  value: '300'
              image: ghcr.io/appuio/appuio-cloud-reporting:v0.17.0
              name: backfill
              resources: {}
          initContainers: []
          restartPolicy: OnFailure
  schedule: 15 * * * *
  startingDeadlineSeconds: 180
  successfulJobsHistoryLimit: 3
  suspend: false
---
apiVersion: batch/v1
kind: CronJob
metadata:
  annotations:
    product-id: bopenshift-worker-vcpu-exoscale-guaranteedavailability
  labels:
    app.kubernetes.io/managed-by: commodore
    app.kubernetes.io/name: appuio-cloud-reporting
    app.kubernetes.io/part-of: syn
    name: backfill-bopenshift-worker-vcpu-exoscale-guaranteedavailability
  name: backfill-bopenshift-worker-vcpu-exoscale-guaranteedavailability
  namespace: appuio-cloud-reporting
spec:
  failedJobsHistoryLimit: 768
  jobTemplate:
    metadata:
      annotations:
        product-id: bopenshift-worker-vcpu-exoscale-guaranteedavailability
      labels:
        app.kubernetes.io/managed-by: commodore
        app.kubernetes.io/name: appuio-cloud-reporting
        app.kubernetes.io/part-of: syn
        cron-job-name: backfill-bopenshift-worker-vcpu-exoscale-guaranteedavailability
    spec:
      template:
        metadata:
          labels:
            app.kubernetes.io/managed-by: commodore
            app.kubernetes.io/name: appuio-cloud-reporting
            app.kubernetes.io/part-of: syn
        spec:
          containers:
            - args:
                - appuio-cloud-reporting report --begin=$(date -d "now -3 hours" -u
                  +"%Y-%m-%dT%H:00:00Z") --repeat-until=$(date -u -Iseconds)
              command:
                - sh
                - -c
              env:
                - name: ACR_ODOO_OAUTH_TOKEN_URL
                  valueFrom:
                    secretKeyRef:
                      key: token_url
                      name: odoo-credentials
                - name: ACR_ODOO_OAUTH_CLIENT_ID
                  valueFrom:
                    secretKeyRef:
                      key: client_id
                      name: odoo-credentials
                - name: ACR_ODOO_OAUTH_CLIENT_SECRET
                  valueFrom:
                    secretKeyRef:
                      key: client_secret
                      name: odoo-credentials
                - name: ACR_ODOO_URL
                - name: ACR_PROM_URL
                  valueFrom:
                    secretKeyRef:
                      key: url
                      name: prom-url
                - name: ACR_PRODUCT_ID
                  value: bopenshift-worker-vcpu-exoscale-guaranteedavailability
                - name: ACR_QUERY
                  value: |-
                    # Calculates vCPUs for app nodes of a cluster
                    # Max values over one hour.
                    max_over_time(
                      sum by(cluster_id, vshn_service_level, tenant_id, role, cloud_provider, sales_order_id) (
                        node_cpu_info * on (tenant_id, cluster_id, instance) group_left(role)
                          label_join(
                            kube_node_role{role=~"app|storage"},
                            "instance",
                            "",
                            "node"
                          ) * on(cluster_id) group_left(tenant_id, vshn_service_level, cloud_provider, sales_order_id)
                            max by(cluster_id, tenant_id, vshn_service_level, cloud_provider, sales_order_id)
                              (appuio_managed_info{cloud_provider="exoscale", vshn_service_level="guaranteed-availability"})
                      )[59m:1m]
                    )
                - name: ACR_INSTANCE_PATTERN
                  value: '%(cluster_id)s'
                - name: ACR_ITEM_GROUP_DESCRIPTION_PATTERN
                  value: 'APPUiO Managed BOpenShift - Cluster: %(cluster_id)s'
                - name: ACR_ITEM_DESCRIPTION_PATTERN
                  value: All Compute Resources
                - name: ACR_UNIT_ID
                  value: '300'
              image: ghcr.io/appuio/appuio-cloud-reporting:v0.17.0
              name: backfill
              resources: {}
          initContainers: []
          restartPolicy: OnFailure
  schedule: 15 * * * *
  startingDeadlineSeconds: 180
  successfulJobsHistoryLimit: 3
  suspend: false
